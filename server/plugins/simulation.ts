import { uploads } from '~/server/data/db';

export default defineNitroPlugin((nitroApp) => {
  console.log('üöÄ –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á...');

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
  setInterval(() => {
    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∑–∞–≥—Ä—É–∑–∫–∞–º –≤ –Ω–∞—à–µ–π "–±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
    uploads.forEach(upload => {
      // –ü—Ä–æ—Å—Ç–∞—è –º–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
      switch (upload.status) {
        case 'new':
          // –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 80% –Ω–∞—á–∏–Ω–∞–µ–º "—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ"
          if (Math.random() < 0.8) {
            upload.status = 'downloading';
            console.log(`[–°–∏–º—É–ª—è—Ç–æ—Ä] –ó–∞–≥—Ä—É–∑–∫–∞ #${upload.id} –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ...`);
          }
          break;
        case 'downloading':
          // –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 70% —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ "–∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è" –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
          if (Math.random() < 0.7) {
            upload.status = 'processing';
            console.log(`[–°–∏–º—É–ª—è—Ç–æ—Ä] –ó–∞–≥—Ä—É–∑–∫–∞ #${upload.id} —Å–∫–∞—á–∞–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...`);
          }
          break;
        case 'processing':
          // –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 90% –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
          if (Math.random() < 0.9) {
            upload.status = 'completed';
            console.log(`[–°–∏–º—É–ª—è—Ç–æ—Ä] –ó–∞–≥—Ä—É–∑–∫–∞ #${upload.id} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!`);
          } else {
            // –ò–Ω–∞—á–µ - –æ—à–∏–±–∫–∞
            upload.status = 'error';
            upload.statusMessage = '–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è: –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥–µ–∫';
            console.error(`[–°–∏–º—É–ª—è—Ç–æ—Ä] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ #${upload.id}`);
          }
          break;
        // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏ –æ—à–∏–±–æ—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
        case 'completed':
        case 'error':
          break;
      }
    });
  }, 3000); // –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
});