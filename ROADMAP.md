# **Project Roadmap**

Это дорожная карта развития проекта, описывающая функционал по спринтам. Каждый спринт представляет собой логический блок работ, нацеленный на достижение конкретного результата.

## **Спринт 1: Прототип и Базовая Инфраструктура (Завершено)**

**Цель:** Создать работающий прототип с базовым UI, аутентификацией и имитацией асинхронной обработки.

*   **Коммит 1.1: `feat(project): initial setup with Nuxt 3, Prisma, Tailwind`**
    *   Настроена базовая структура проекта Nuxt 3.
    *   Интегрирован `docker-compose.yml` с сервисами: Postgres, Redis, MinIO.
    *   Настроена ORM Prisma и создана первоначальная миграция БД.
    *   Реализована базовая структура страниц и компонентов с использованием TailwindCSS.

*   **Коммит 1.2: `feat(auth): implement user authentication`**
    *   Реализованы модели `User` и `Role` в схеме Prisma.
    *   Созданы API-эндпоинты для регистрации и логина (`/api/v1/auth/...`).
    *   Интегрирована аутентификация на основе JWT.
    *   Создан `useAuth` composable для управления состоянием пользователя на клиенте.
    *   Реализованы серверные и клиентские middleware для защиты роутов.

*   **Коммит 1.3: `feat(admin): create basic content management`**
    *   Реализованы модели `Series`, `Season`, `Episode`, `Translator`, `Composition` в Prisma.
    *   Создана базовая админ-панель для CRUD-операций с контентом.

*   **Коммит 1.4: `feat(player): implement basic player page`**
    *   Создана страница плеера `/series/[id]`.
    *   Реализован выбор сезона, эпизода и доступного перевода (`Composition`).

*   **Коммит 1.5: `feat(worker): implement proof-of-concept async processing`**
    *   Реализованы первоначальные модели `Upload` и `MediaStream`.
    *   Настроена система очередей BullMQ для фоновых задач.
    *   Создан независимый процесс-воркер (`worker.ts`), способный:
        *   Скачивать файлы по URL (`yt-dlp`).
        *   Демультиплексировать их на видео/аудио потоки (`ffmpeg`).
        *   Загружать результирующие файлы в S3-хранилище (MinIO).
    *   Создан UI для добавления URL в очередь на обработку.

---

## **Спринт 2: Фундамент — Единая система файлов (`FileAsset`)**

**Цель:** Провести глобальный рефакторинг, заменив старую логику (`Upload`) на новую, унифицированную систему `FileAsset` и реализовав современную прямую загрузку в S3.

*   **Коммит 2.1: `refactor(prisma): implement unified FileAsset model`**
    *   Переписать схему Prisma: ввести центральную модель `FileAsset` и связанные мета-модели `MediaFileMeta`, `PersonalFileMeta`, `PersonalFolder`.
    *   Модифицировать модель `MediaStream`, чтобы она ссылалась на `MediaFileMeta`.
    *   Удалить старую модель `Upload`.
    *   Сгенерировать новую, чистую миграцию БД (рекомендуется пересоздать БД).

*   **Коммит 2.2: `feat(api): implement direct S3 upload with pre-signed URLs`**
    *   Создать единый API-эндпоинт `POST /api/v1/assets/upload-url`.
    *   Эндпоинт принимает `filename`, `size`, `mimeType` и **контекст** (тип `PERSONAL` или `MEDIA`).
    *   **Логика:** Генерирует pre-signed URL для `PUT` запроса, создает запись `FileAsset` (и `...Meta`) со статусом `PENDING`, возвращает URL на клиент.

*   **Коммит 2.3: `feat(api): implement upload finalization and job queuing`**
    *   Создать эндпоинт `POST /api/v1/assets/[id]/finalize`.
    *   **Логика:** Клиент вызывает его после загрузки в S3. Сервер проверяет наличие файла, обновляет статус `FileAsset` на `AVAILABLE` (для личных файлов) или `PROCESSING` (для медиа) и **ставит задачу в очередь BullMQ для медиа-файлов**.

*   **Коммит 2.4: `feat(ui): create Personal Storage UI`**
    *   Создать новую страницу `pages/account/storage/`.
    *   Реализовать UI для личного хранилища: отображение иерархии папок и файлов, навигация ("хлебные крошки").
    *   Интегрировать новую логику загрузки файлов с диска через pre-signed URL.
    *   Реализовать UI для создания папок, переименования, удаления и перемещения файлов/папок (drag-n-drop).

---

## **Спринт 3: Медиа-конвейер на новой архитектуре**

**Цель:** Полностью адаптировать систему обработки медиа для работы с новой моделью `FileAsset`.

*   **Коммит 3.1: `refactor(worker): adapt worker to FileAsset model`**
    *   Переписать воркер. Теперь он получает из очереди `assetId`.
    *   **Логика:** Находит `FileAsset`, скачивает исходник из S3 во временную папку, выполняет демультиплексирование/транскодирование, загружает результаты в S3, создает записи `MediaStream` и обновляет статус `FileAsset` на `AVAILABLE`.

*   **Коммит 3.2: `refactor(ui): update media upload workflow`**
    *   Переделать страницу `/account/uploads` (переименовать в `/account/media-assets`).
    *   Она теперь отображает список `FileAsset` с типом `MEDIA` и их статусы обработки.
    *   Форма загрузки медиа (как по URL, так и с диска) должна использовать единый механизм `FileAsset`.

*   **Коммит 3.3: `feat(ui): implement Media Asset configuration`**
    *   На странице отдельного медиа-ассета (`/account/media-assets/[id]`) реализовать UI для привязки его к эпизоду (`linkedEpisodeId` в `MediaFileMeta`).
    *   Здесь же реализовать конструктор `Composition` из производных потоков (`MediaStream`).

---

## **Спринт 4: Продвинутые возможности и Плеер**

**Цель:** Восстановить функционал плеера на новой архитектуре и добавить поддержку торрентов.

*   **Коммит 4.1: `refactor(player): integrate player with new models`**
    *   Адаптировать страницу плеера `/series/[id]` и эндпоинт `translations.get.ts` для работы с новыми моделями `FileAsset` -> `MediaFileMeta` -> `MediaStream` -> `Composition`.

*   **Коммит 4.2: `feat(worker): add torrent processing support`**
    *   Добавить торрент-клиент (Transmission) в `docker-compose.yml`.
    *   Расширить воркер: добавить новый тип задачи `process-torrent`, который взаимодействует с API торрент-клиента, а после скачивания запускает стандартный медиа-конвейер для каждого файла.

*   **Коммит 4.3: `feat(ui): add torrent upload UI`**
    *   Добавить в UI возможность загрузки по `magnet`-ссылке или через `.torrent` файл.
    *   Реализовать UI с метаданными торрента, где пользователь может выбрать, какие файлы из раздачи загружать.

*   **Коммит 4.4: `feat(player): implement subtitle support`**
    *   Добавить извлечение субтитров в воркере и их сохранение как `MediaStream` с типом `SUBTITLE`.
    *   Обновить эндпоинт плеера и сам плеер для отображения субтитров.

---

## **Спринт 5: Продвинутый UX и Управление**

**Цель:** Значительно улучшить удобство использования приложения.

*   **Коммит 5.1: `feat(ux): enhance series page experience`**
    *   Автоматический выбор первого сезона/эпизода при заходе на страницу сериала.
    *   Сохранение последнего просмотренного эпизода и перевода в `localStorage`.

*   **Коммит 5.2: `feat(admin): improve content management UX`**
    *   **Управление пользователями:** Создать страницу `/admin/users` с возможностью изменять роль пользователя.
    *   **Расширение метаданных:** Добавить в модели `Series`/`Episode` поля (год, студия, жанры) и реализовать их редактирование в админ-панели.
    *   **Автозаполнение:** При создании нового эпизода автоматически подставлять следующий по порядку номер.

*   **Коммит 5.3: `feat(compositions): allow null translator`**
    *   Сделать связь `translator` в модели `Composition` опциональной.
    *   Обновить UI, чтобы позволить создавать сборки без указания переводчика.

*   **Коммит 5.4: `feat(batch): implement advanced batch composition creation`**
    *   Создать UI для пакетного создания `Composition`. Пользователь выбирает несколько `FileAsset`, настраивает шаблон для первого и применяет его ко всем остальным.

---

## **Спринт 6: Полноценная Конвертация и Настройка**

**Цель:** Добавить возможность настройки форматов, в которые будут конвертироваться медиа-файлы.

*   **Коммит 6.1: `feat(config): implement configuration backend`**
    *   Реализовать бэкенд и UI в админ-панели для управления настройками приложения (ключи, пути и т.д.).

*   **Коммит 6.2: `feat(config): implement transcoding options`**
    *   Добавить в настройки параметры для транскодирования видео и аудио (кодек, битрейт, разрешение, контейнер).
    *   Реализовать пресеты (`1080p H264`, `720p AV1` и т.д.) для удобства.

*   **Коммит 6.3: `refactor(worker): implement transcoding logic`**
    *   Изменить воркер так, чтобы он читал актуальный конфиг и транскодировал файлы в соответствии с заданными параметрами, создавая несколько `MediaStream` разного качества из одного исходника.

*   **Коммит 6.4: `feat(player): add quality selection to player`**
    *   Обновить плеер для поддержки выбора качества видео (и, возможно, аудио).

---

## **Спринт 7: Мультиязычность**

**Цель:** Добавить поддержку нескольких языков для интерфейса и контента.

*   **Коммит 7.1: `feat(translations): add language fields to models`**
    *   Добавить поле `language` в модели `MediaStream` и `Composition`.
    *   Добавить UI для указания языка и его автоопределения из метаданных.

*   **Коммит 7.2: `feat(i18n): implement UI internationalization`**
    *   Интегрировать библиотеку для i18n (например, `@nuxtjs/i18n`).
    *   Обернуть все строки в интерфейсе в функции перевода.
    *   Реализовать меню для выбора языка интерфейса.

---

## **Спринт 8: Финальная полировка и Подготовка к Production**

**Цель:** Добавить последние штрихи, которые делают приложение готовым к реальному использованию.

*   **Коммит 8.1: `feat(ui): implement notification system`**
    *   Внедрить систему всплывающих уведомлений (Toasts) для всех операций.

*   **Коммит 8.2: `feat(ux): real-time status updates with SSE`**
    *   Реализовать Server-Sent Events для мгновенного обновления статусов обработки ассетов без перезагрузки страницы.

*   **Коммит 8.3: `refactor(config): externalize all settings`**
    *   Провести финальный аудит кода и убедиться, что все настраиваемые параметры вынесены в конфигурационные файлы.

*   **Коммит 8.4: `docs(setup): create deployment documentation`**
    *   Написать подробную документацию по развертыванию проекта на VPS с использованием Docker.